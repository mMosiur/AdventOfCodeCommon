name: Publish NuGet package

on:
  push:
    branches: [ 'main' ]
    paths:
    - 'Source/**'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (skip actual publish)'
        required: false
        type: boolean
        default: false

jobs:

  build-package:
    runs-on: ubuntu-latest
    env:
      CI: true
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      package-exists: ${{ steps.check-version.outputs.exists }}

    steps:

    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x
          9.0.x
          8.0.x
          7.0.x

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: Get package version
      id: get-version
      run: |
        VERSION=$(grep -oP '<Version>\K[^<]+' Source/Common.csproj)
        echo 'version=$VERSION' >> $GITHUB_OUTPUT
        echo 'Package version: $VERSION'

    - name: Check if version exists on NuGet
      id: check-version
      run: |
        PACKAGE_ID='mMosiur.AdventOfCode.Common'
        VERSION='${{ steps.get-version.outputs.version }}'
        STATUS=$(curl -s -o /dev/null -w '%{http_code}' 'https://api.nuget.org/v3-flatcontainer/$PACKAGE_ID/$VERSION/$PACKAGE_ID.$VERSION.nupkg')
        if [ '$STATUS' = '200' ]; then
          echo 'exists=true' >> $GITHUB_OUTPUT
          echo '⚠️ Version $VERSION already exists on NuGet'
        else
          echo 'exists=false' >> $GITHUB_OUTPUT
          echo '✅ Version $VERSION is new'
        fi

    - name: Restore dependencies
      run: dotnet restore Source/Common.csproj

    - name: Build
      run: dotnet build Source/Common.csproj --configuration Release --no-restore

    - name: Create package
      run: dotnet pack Source/Common.csproj --configuration Release --no-build --output ./artifacts

    - name: Upload package artifacts
      uses: actions/upload-artifact@v5
      with:
        name: nuget-packages
        path: ./artifacts/*.nupkg
        if-no-files-found: error

    - name: Upload symbol artifacts
      uses: actions/upload-artifact@v5
      with:
        name: symbol-packages
        path: ./artifacts/*.snupkg
        if-no-files-found: error

  publish-package-to-github:
    needs: build-package
    if: needs.build-package.outputs.package-exists == 'false' && !inputs.dry-run
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:

    - name: Download package artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./packages

# (Removed redundant step: Download built package)
    - name: Publish package to GitHub
      run: dotnet nuget push './packages/*.nupkg' \
        --source 'https://nuget.pkg.github.com/mMosiur/index.json' \
        --api-key '${{ secrets.GITHUB_TOKEN }}' \
        --skip-duplicate

  publish-package-to-nuget:
    needs: build-package
    if: needs.build-package.outputs.package-exists == 'false' && !inputs.dry-run
    runs-on: ubuntu-latest
    steps:

    - name: Download package artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./packages

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push './packages/*.nupkg' \
          --source 'https://api.nuget.org/v3/index.json' \
          --api-key '${{ secrets.NUGET_API_KEY }}' \
          --skip-duplicate

  create-release:
    needs: [ build-package, publish-package-to-nuget ]
    if: needs.build-package.outputs.package-exists == 'false' && !inputs.dry-run
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build-package.outputs.version }}
          name: v${{ needs.build-package.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./artifacts/nuget-packages/*.nupkg
            ./artifacts/symbol-packages/*.snupkg
