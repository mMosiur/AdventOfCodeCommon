name: Publish NuGet package

on:
  push:
    branches: [ 'main' ]
    paths:
    - 'Source/**'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (skip actual publish)'
        required: false
        type: boolean
        default: false

jobs:

  build-package:
    runs-on: ubuntu-latest
    env:
      CI: true
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:

    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x
          9.0.x
          8.0.x
          7.0.x

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: Get package version
      id: get-version
      run: |
        VERSION=$(grep -oP '<Version>\K[^<]+' Source/Common.csproj)
        echo 'version=$VERSION' >> $GITHUB_OUTPUT
        echo 'Package version: $VERSION'

    - name: Restore dependencies
      run: dotnet restore Source/Common.csproj

    - name: Build
      run: dotnet build Source/Common.csproj --configuration Release --no-restore

    - name: Create package
      run: dotnet pack Source/Common.csproj --configuration Release --no-build --output ./artifacts

    - name: Upload package artifacts
      uses: actions/upload-artifact@v5
      with:
        name: nuget-packages
        path: ./artifacts/*.nupkg
        if-no-files-found: error

    - name: Upload symbol artifacts
      uses: actions/upload-artifact@v5
      with:
        name: symbol-packages
        path: ./artifacts/*.snupkg
        if-no-files-found: error

  publish-package-to-github:
    needs: build-package
    if: ${{ !inputs.dry-run }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:

    - name: Add GitHub NuGet source
      run: dotnet nuget add source "https://nuget.pkg.github.com/mMosiur/index.json" --name github --username mMosiur --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text

    - name: Download package artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./packages

    - name: Publish package to GitHub
      run: dotnet nuget push './packages/*.nupkg' --source github --api-key '${{ secrets.GITHUB_TOKEN }}' --skip-duplicate

  publish-package-to-nuget:
    needs: build-package
    if: ${{ !inputs.dry-run }}
    runs-on: ubuntu-latest
    steps:

    - name: Download package artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./packages

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push './packages/*.nupkg' \
          --source 'https://api.nuget.org/v3/index.json' \
          --api-key '${{ secrets.NUGET_API_KEY }}' \
          --skip-duplicate
